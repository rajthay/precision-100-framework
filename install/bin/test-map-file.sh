#!/bin/bash

TABLE_NAME=$1
SOURCE_FILE=$2

source $PRECISION100_FOLDER/conf/.map-file.env.sh

MAP_FILE_JOIN_FILTER="__JOIN__"
DDL_SOURCE_FILE="${TABLE_NAME}.ddl"
JOIN_SOURCE_FILE="${TABLE_NAME}.join"

O_TABLE_SQL="${DEFAULT_TABLE_NAME_PREFIX}-${TABLE_NAME}.sql"
O_TAB_COLUMN_SQL="${DEFAULT_TABLE_NAME_PREFIX}-${TABLE_NAME}-${DEFAULT_TAB_COLUMN_SUFFIX}.sql"
TRANSFORM_SQL="${DEFAULT_TABLE_NAME_PREFIX}-${TABLE_NAME}-${DEFAULT_TRANSFORM_SUFFIX}.sql"

grep -i -v ${MAP_FILE_JOIN_FILTER} $SOURCE_FILE > "${DDL_SOURCE_FILE}"
sed -n "s/${MAP_FILE_JOIN_FILTER},//p" $SOURCE_FILE  > "${JOIN_SOURCE_FILE}"


echo "        MAP-FILE ADAPTOR CREATING O_ TABLE SCRIPT"
$PRECISION100_FOLDER/bin/map-file-o-table.sh $TABLE_NAME $DDL_SOURCE_FILE > $O_TABLE_SQL

echo "        MAP-FILE ADAPTOR CREATING INSERT TABLE METADATA SCRIPT"
$PRECISION100_FOLDER/bin/map-file-tab-columns.sh $TABLE_NAME $DDL_SOURCE_FILE > $O_TAB_COLUMN_SQL

echo "        MAP-FILE ADAPTOR CREATING TRANSFORM SCRIPT"
$PRECISION100_FOLDER/bin/map-file-transform.sh $TABLE_NAME $DDL_SOURCE_FILE $JOIN_SOURCE_FILE > $TRANSFORM_SQL

